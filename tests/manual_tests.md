# Installation

```
docker run -t ubuntu:20.04

# install necessary packages
apt-get update
apt-get install -y python3-pip python3-dev cron


apt-get remove --purge ansible
apt-get install software-properties-common -y
apt-add-repository ppa:ansible/ansible -y
apt-get update
apt-get install ansible git nano sudo -y

cd /opt
# get dx-streaming uploader code
git clone -b APPS-742-novaseq-fix --single-branch https://github.com/dnanexus-rnd/dx-streaming-upload.git
```

# MiSeq/HiSeq setup

## 1. Create dx-upload-play yaml file

### Note: you will need to put your project id

```
cd dx-streaming-upload
cp tests/test.yml /opt/dx-upload-play-miseq.yml
cd ..
nano dx-upload-play-miseq.yml

# update the yml file as needed, see example below

---
- hosts: localhost
  vars:
    monitored_users:
      - username: root
        # applet: applet-Bq2Kkgj08FqbjV3J8xJ0K3gG
        # workflow: workflow-xxx
        monitored_directories:
          - ~/runs
        run_length: 24h
        min_size: 5
        # max_size: 500
        n_seq_intervals: 2
        n_retries: 5
    mode: debug
    upload_project: project-xxxx

  roles:
    - dx-streaming-upload
```

## 2. Create folder structure to simulate files generated by sequencer

### Note: folder name needs to be the same as the Run Id in the RunInfo.xml file - see step 3

```
mkdir -p /root/runs/180725_test_miseq
cd /root/runs/180725_test_miseq
touch RunInfo.xml SampleSheet.csv RTAComplete.txt
```

## 3. Edit RunInfo.xml file

```
<?xml version="1.0" encoding="utf-8"?>
<RunInfo>
    <Run Id="180725_test_miseq" Number="10">
        <Flowcell>H3WVNDSXX</Flowcell>
        <Instrument>A00364</Instrument>
        <Date>7/25/2018 3:31:31 PM</Date>
        <Reads>
            <Read Number="1" NumCycles="151" IsIndexedRead="N"/>
            <Read Number="2" NumCycles="8" IsIndexedRead="Y"/>
            <Read Number="3" NumCycles="8" IsIndexedRead="Y"/>
            <Read Number="4" NumCycles="151" IsIndexedRead="N"/>
        </Reads>
        <FlowcellLayout LaneCount="4" SurfaceCount="2" SwathCount="6" TileCount="78" FlowcellSide="1">
            <TileSet TileNamingConvention="FourDigit">
                <Tiles>
                    <Tile>1_2101</Tile>
                </Tiles>
            </TileSet>
        </FlowcellLayout>
        <AlignToPhiX/>
        <ImageDimensions Width="3200" Height="3607"/>
        <ImageChannels>
            <Name>RED</Name>
            <Name>GREEN</Name>
        </ImageChannels>
    </Run>
</RunInfo>
```

## 4. Create file(s)to upload, needs to be big enough

```
dd if=/dev/zero of=/root/runs/180725_test_miseq/output.dat  bs=200M count=10
```

## 5. Put everything together with ansible-playbook

### Note: specify your own token

```
ansible-playbook /opt/dx-upload-play-miseq.yml --extra-vars "dx_token=xxxxxxx"
```

# NovaSeq setup

## 1. Create dx-upload-play yaml file

**`novaseq: True`**

### Note: you will need to put your project id

```
cd /opt/dx-streaming-upload
cp tests/test.yml /opt/dx-upload-play-novaseq.yml
# update the yml file as needed, see example below

---
- hosts: localhost
  vars:
    monitored_users:
      - username: root
        # applet: applet-Bq2Kkgj08FqbjV3J8xJ0K3gG
        # workflow: workflow-xxx
        monitored_directories:
          - ~/runs
        run_length: 24h
        min_size: 5
        # max_size: 500
        n_seq_intervals: 2
        n_retries: 5
   novaseq: True
    mode: debug
    upload_project: project-xxxx

  roles:
    - dx-streaming-upload
```

## 2. Create folder structure to simulate files generated by sequencer

### Note: folder name needs to be the same as the Run Id in the RunInfo.xml file - see step 3

```
mkdir -p /root/runs/180725_test_novaseq
cd /root/runs/180725_test_novaseq
touch RunInfo.xml SampleSheet.csv RTAComplete.txt CopyComplete.txt
```

## 3. Edit RunInfo.xml file

```
<?xml version="1.0" encoding="utf-8"?>
<RunInfo>
    <Run Id="180725_test_novaseq" Number="10">
        <Flowcell>H3WVNDSXX</Flowcell>
        <Instrument>A00364</Instrument>
        <Date>7/25/2018 3:31:31 PM</Date>
        <Reads>
            <Read Number="1" NumCycles="151" IsIndexedRead="N"/>
            <Read Number="2" NumCycles="8" IsIndexedRead="Y"/>
            <Read Number="3" NumCycles="8" IsIndexedRead="Y"/>
            <Read Number="4" NumCycles="151" IsIndexedRead="N"/>
        </Reads>
        <FlowcellLayout LaneCount="4" SurfaceCount="2" SwathCount="6" TileCount="78" FlowcellSide="1">
            <TileSet TileNamingConvention="FourDigit">
                <Tiles>
                    <Tile>1_2101</Tile>
                </Tiles>
            </TileSet>
        </FlowcellLayout>
        <AlignToPhiX/>
        <ImageDimensions Width="3200" Height="3607"/>
        <ImageChannels>
            <Name>RED</Name>
            <Name>GREEN</Name>
        </ImageChannels>
    </Run>
</RunInfo>
```

## 4. Create file(s)to upload, needs to be big enough

```
dd if=/dev/zero of=/root/runs/180725_test_novaseq/output.dat  bs=200M count=10
```

## 5. Put everything together with [ansible-playbook](https://docs.ansible.com/ansible/latest/user_guide/playbooks.html)
### Note: specify your own token

```
ansible-playbook /opt/dx-upload-play-novaseq.yml --extra-vars "dx_token=xxxxxxx"
```

# Run
### Before running, make sure to run the following command to remove unnecessary files

```
cd /root

rm /root/dnanexus/upload/LOGS/*log
rm /root/*log
rm /var/lock/*lock
```

### It is also good to remove the folder to which the data are uploaded by dx-streaming uploader

```
dx rm -rf 180725_test_miseq # for miseq
dx rm -rf 180725_test_novaseq # for novaseq
```

### Run the dx-streaming uploader via cron (set to launch every 1 minute)

```
service cron start

1 check your project to see if the files show up there
```

### Monitor what is going on 
- Look into `/root/monitor-xxxxx.log`
- Look into `/root/dnanexus/upload/LOGS/*_test.lane.all.log`

